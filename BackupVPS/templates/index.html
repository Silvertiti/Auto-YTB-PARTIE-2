<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Bot - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #0f172a; color: #cbd5e1; }
        .input-dark { background-color: #1e293b; border: 1px solid #334155; color: white; }
        .input-dark:focus { border-color: #3b82f6; outline: none; }
        input::-webkit-calendar-picker-indicator { opacity: 0; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 50; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .sortable-header { cursor: pointer; user-select: none; transition: color 0.2s; }
        .sortable-header:hover { color: #ffffff; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto space-y-6">

        <div class="bg-slate-800 p-6 rounded-lg shadow-2xl border border-slate-700">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-700">
                <h1 class="text-xl font-bold text-white tracking-wide">ðŸ¤– Twitch Bot V5</h1>
                <div id="status_dot" class="w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]"></div>
            </div>

            <div class="space-y-5">
                <div class="grid grid-cols-3 gap-3">
                    <div class="col-span-1">
                        <label class="block text-xs text-slate-400 font-bold uppercase mb-1">Je cherche</label>
                        <select id="type" onchange="updateList()" class="w-full p-3 rounded bg-slate-900 border border-slate-600 text-white focus:border-blue-500 outline-none">
                            <option value="channel" selected>ðŸ‘¤ Streamer</option>
                            <option value="game">ðŸŽ® Jeu</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs text-slate-400 font-bold uppercase mb-1">Nom</label>
                        <div class="relative">
                            <input id="query" type="text" list="current-list" placeholder="Nom du Streamer..." class="w-full p-3 rounded bg-slate-900 border border-slate-600 text-white font-semibold focus:border-blue-500 outline-none">
                        </div>
                    </div>
                </div>

                <datalist id="streamers-list">
                    <option value="anyme023"><option value="JLTomy"><option value="Gotaga"><option value="Kamet0"><option value="Aminematue"><option value="ZeratoR"><option value="Squeezie"><option value="Domingo"><option value="Etoiles">
                </datalist>
                <datalist id="games-list">
                    <option value="Grand Theft Auto V"><option value="League of Legends"><option value="Just Chatting"><option value="Valorant"><option value="Minecraft"><option value="Fortnite">
                </datalist>

                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="text-xs text-slate-400 font-bold uppercase mb-1">PÃ©riode</label>
                        <select id="period" class="w-full p-2 rounded input-dark text-sm">
                            <option value="24h">24h</option>
                            <option value="7d">7 jours</option>
                            <option value="30d">30 jours</option>
                            <option value="all">Tout</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-bold uppercase mb-1">QuantitÃ©</label>
                        <input id="nb_videos" type="number" value="1" min="1" class="w-full p-2 rounded input-dark text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-bold uppercase mb-1">Langue</label>
                        <input id="lang" type="text" value="fr" class="w-full p-2 rounded input-dark text-center text-sm uppercase">
                    </div>
                </div>

                <hr class="border-slate-700">

                <div>
                    <div class="flex justify-between mb-1">
                        <label class="text-xs text-slate-400 font-bold uppercase">Compte TikTok</label>
                        <button onclick="openAccountModal()" class="text-xs text-blue-400 hover:text-white transition">+ Ajouter</button>
                    </div>
                    <select id="tiktok_account" class="w-full p-3 rounded bg-slate-900 border border-slate-600 text-white focus:border-pink-500 outline-none">
                        {% for account in accounts %}
                            <option value="{{ account }}">{{ account }}</option>
                        {% else %}
                            <option value="" disabled selected>-- Aucun compte --</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="bg-slate-900/50 p-3 rounded border border-slate-700">
                    <div class="flex justify-between items-center">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="send_telegram" checked class="w-4 h-4 rounded bg-slate-800 border-slate-600 text-blue-500">
                            <span class="ml-2 text-sm">Telegram</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="auto_post" onchange="toggleSchedule()" class="w-4 h-4 rounded bg-slate-800 border-slate-600 text-pink-500">
                            <span class="ml-2 text-sm text-pink-400">Auto-Post TikTok</span>
                        </label>
                    </div>
                    <div id="schedule_zone" class="hidden mt-3 pt-3 border-t border-slate-700 flex items-center justify-between">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="publish_now" checked onchange="toggleTimeInputs()" class="w-4 h-4 rounded bg-slate-800 text-green-500">
                            <span class="ml-2 text-xs text-green-400">Publier de suite</span>
                        </label>
                        <div id="time_inputs" class="flex items-center gap-1 opacity-50 pointer-events-none transition-opacity">
                            <input type="number" id="schedule_hour" value="18" class="w-10 p-1 text-center rounded bg-slate-800 border border-slate-600 text-xs">
                            <span class="text-slate-500 font-bold">:</span>
                            <input type="number" id="schedule_minute" value="00" class="w-10 p-1 text-center rounded bg-slate-800 border border-slate-600 text-xs">
                        </div>
                    </div>
                </div>

                <button onclick="launchBot()" id="btn" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-bold py-3 rounded-lg shadow-lg transition transform active:scale-[0.98] mt-2">
                    ðŸš€ LANCER
                </button>
                <div id="status" class="text-xs font-mono text-center text-slate-500 h-4"></div>
            </div>
        </div>

        <div class="bg-slate-800 rounded-lg shadow-2xl border border-slate-700 overflow-hidden">
            <div class="bg-slate-900 p-4 border-b border-slate-700 flex justify-between items-center">
                <h2 class="text-sm font-bold text-slate-300 uppercase tracking-wide">ðŸ“Š Statistiques TikTok</h2>
                <div class="flex gap-2">
                    <button onclick="forceScan()" class="text-[10px] bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-1 rounded font-bold transition flex items-center gap-1">
                        ðŸ”„ FORCER SCAN
                    </button>
                    <button onclick="openVideoModal()" class="text-[10px] bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded font-bold transition">+ AJOUTER VIDÃ‰O</button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-900/50 text-slate-400 text-[10px] uppercase font-bold">
                        <tr>
                            <th class="p-4 sortable-header" onclick="sortTable('account')">Compte <span id="sort_account"></span></th>
                            <th class="p-4 sortable-header" onclick="sortTable('title')">VidÃ©o <span id="sort_title"></span></th>
                            <th class="p-4 text-center sortable-header" onclick="sortTable('views')">Vues / Ã‰vol. <span id="sort_views"></span></th>
                            <th class="p-4 text-center sortable-header" onclick="sortTable('likes')">Likes <span id="sort_likes"></span></th>
                            <th class="p-4 text-center sortable-header text-yellow-500" onclick="sortTable('ratio')">Ratio % <span id="sort_ratio"></span></th>
                            <th class="p-4 text-right sortable-header" onclick="sortTable('pubDateObj')">ðŸ“… Date Pub. <span id="sort_pubDateObj">â–¼</span></th>
                        </tr>
                    </thead>
                    <tbody id="table_body" class="divide-y divide-slate-700">
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <div id="accountModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-slate-800 p-6 rounded-lg border border-slate-600 w-80 shadow-2xl">
            <h3 class="font-bold text-white mb-4 text-center">Nouveau Compte</h3>
            <input id="new_name" type="text" placeholder="Nom (ex: HAWAII)" class="w-full p-2 mb-3 rounded bg-slate-900 border border-slate-600 text-white text-sm">
            <input id="new_id" type="text" placeholder="ID (ex: 697a...)" class="w-full p-2 mb-5 rounded bg-slate-900 border border-slate-600 text-white text-sm">
            <div class="flex justify-between">
                <button onclick="closeAccountModal()" class="px-4 py-2 text-slate-400 hover:text-white text-sm">Annuler</button>
                <button onclick="saveAccount()" class="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded text-sm font-bold">Sauvegarder</button>
            </div>
        </div>
    </div>

    <div id="chartModal" class="modal p-4" onclick="closeChartModal()">
        <div class="bg-slate-800 w-full max-w-2xl p-6 rounded-xl border border-slate-600" onclick="event.stopPropagation()">
            <div class="flex justify-between items-start mb-4">
                <h3 id="modalTitle" class="text-white font-bold truncate pr-4"></h3>
                <button onclick="closeChartModal()" class="text-slate-400 hover:text-white text-xl">âœ•</button>
            </div>
            <div style="height: 300px; position: relative;">
                <canvas id="modalCanvas"></canvas>
            </div>
        </div>
    </div>

    <div id="videoModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-slate-800 p-6 rounded-lg border border-slate-600 w-96 shadow-2xl">
            <h3 class="font-bold text-white mb-4 text-center">ðŸŽ¥ Ajouter une vidÃ©o Ã  suivre</h3>
            <input id="new_video_url" type="text" placeholder="https://www.tiktok.com/@user/video/123..." class="w-full p-3 mb-3 rounded bg-slate-900 border border-slate-600 text-white text-sm">
            <div id="video_status" class="text-xs text-center mb-3 h-4"></div>
            <div class="flex justify-between">
                <button onclick="closeVideoModal()" class="px-4 py-2 text-slate-400 hover:text-white text-sm">Annuler</button>
                <button onclick="saveVideo()" class="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded text-sm font-bold">Ajouter</button>
            </div>
        </div>
    </div>

    <script>
        let myChart = null;
        let globalData = []; 
        let currentSort = { column: 'pubDateObj', direction: 'desc' };

        function updateList() {
            const type = document.getElementById('type').value;
            const input = document.getElementById('query');
            input.value = "";
            input.setAttribute('list', type === 'channel' ? 'streamers-list' : 'games-list');
            input.placeholder = type === 'channel' ? "Nom du Streamer..." : "Nom du Jeu...";
        }
        window.onload = updateList;

        function toggleSchedule() { document.getElementById('schedule_zone').classList.toggle('hidden', !document.getElementById('auto_post').checked); }
        function toggleTimeInputs() {
            const inputs = document.getElementById('time_inputs');
            if(document.getElementById('publish_now').checked) inputs.classList.add('opacity-50', 'pointer-events-none');
            else inputs.classList.remove('opacity-50', 'pointer-events-none');
        }

        function openAccountModal() { document.getElementById('accountModal').classList.replace('hidden', 'flex'); }
        function closeAccountModal() { document.getElementById('accountModal').classList.replace('flex', 'hidden'); }
        function closeChartModal() { document.getElementById('chartModal').classList.remove('active'); }
        function openVideoModal() { 
            document.getElementById('videoModal').classList.replace('hidden', 'flex'); 
            document.getElementById('new_video_url').value = '';
            document.getElementById('video_status').innerText = '';
        }
        function closeVideoModal() { document.getElementById('videoModal').classList.replace('flex', 'hidden'); }

        async function forceScan() {
            if(!confirm("Lancer une mise Ã  jour forcÃ©e des statistiques ?")) return;
            try {
                const res = await fetch('/force_scan', { method: 'POST' });
                const data = await res.json();
                alert(data.message);
                loadStats();
            } catch(e) { alert("Erreur lors du lancement du scan."); }
        }

        async function saveVideo() {
            const url = document.getElementById('new_video_url').value.trim();
            if(!url) return;
            try {
                const res = await fetch('/add_video', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({url}) });
                const data = await res.json();
                document.getElementById('video_status').innerText = data.status === 'success' ? "âœ… " + data.message : "âŒ " + data.message;
                if(data.status === 'success') { setTimeout(closeVideoModal, 1500); loadStats(); }
            } catch(e) { console.error(e); }
        }

        async function saveAccount() {
            const name = document.getElementById('new_name').value;
            const id = document.getElementById('new_id').value;
            if(!name || !id) return;
            await fetch('/add_account', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({name, id}) });
            location.reload();
        }

        async function launchBot() {
            const btn = document.getElementById('btn');
            const status = document.getElementById('status');
            btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed');
            status.innerText = "â³ Envoi de la commande...";

            const payload = {
                query: document.getElementById('query').value,
                type: document.getElementById('type').value,
                period: document.getElementById('period').value,
                nb_videos: document.getElementById('nb_videos').value,
                lang: document.getElementById('lang').value,
                tiktok_account: document.getElementById('tiktok_account').value,
                auto_post: document.getElementById('auto_post').checked,
                send_telegram: document.getElementById('send_telegram').checked,
                publish_now: document.getElementById('publish_now').checked,
                schedule_hour: document.getElementById('schedule_hour').value,
                schedule_minute: document.getElementById('schedule_minute').value
            };

            try {
                const res = await fetch('/run', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                const data = await res.json();
                status.innerText = (res.status === 429 ? "âš ï¸ " : (data.status === 'success' ? "âœ… " : "âŒ ")) + data.message;
                status.className = "text-xs font-mono text-center mt-2 h-4 font-bold " + (data.status === 'success' ? "text-green-400" : "text-red-400");
            } catch (e) { status.innerText = "âŒ Erreur serveur"; }
            setTimeout(() => { btn.disabled = false; btn.classList.remove('opacity-50', 'cursor-not-allowed'); }, 3000);
        }

        function getTikTokDate(url) {
            try {
                const match = url.match(/\/video\/(\d+)/);
                if (match && match[1]) {
                    const videoId = BigInt(match[1]);
                    const timestamp = Number(videoId >> 32n);
                    return new Date(timestamp * 1000);
                }
            } catch(e) { return null; }
            return null;
        }

        // --- TENDANCE CLEAN ---
        function calculateTrend(history) {
            if (!history || history.length < 2) return { icon: 'NEW', color: 'text-blue-400 font-bold text-[10px]' };

            const current = history[history.length - 1];
            const previous = history[history.length - 2];

            const viewsNow = current.views || 0;
            const viewsPrev = previous.views || 0;

            const diff = viewsNow - viewsPrev;

            
            // 1. Si 0 vue en 1h -> Stagnation
            if (diff === 0) return { icon: '=', color: 'text-slate-600 font-bold' }; 
            
            // 2. Si +500 vues en 1h -> C'est un BUZZ (Orange Clignotant)
            if (diff > 500) return { icon: 'â–²', color: 'text-orange-500 animate-pulse' }; 
            
            // 3. Si entre 1 et 499 vues -> Croissance normale (Vert)
            if (diff > 0) return { icon: 'â–²', color: 'text-green-400' };

            return { icon: '', color: '' };
        }

        async function loadStats() {
            try {
                const res = await fetch('/video_analytics.json?nocache=' + new Date().getTime());
                const rawData = await res.json();

                const grouped = {};
                rawData.forEach(item => {
                    const key = item.url || item.id || 'unknown';
                    if (!grouped[key]) grouped[key] = [];
                    grouped[key].push(item);
                });

                globalData = Object.keys(grouped).map(url => {
                    const history = grouped[url];
                    const last = history[history.length - 1];
                    const views = last.views || 0;
                    const likes = last.likes || 0;
                    const ratio = views > 0 ? parseFloat(((likes / views) * 100).toFixed(2)) : 0;
                    const timestamp = last.last_updated || 'N/A';
                    
                    let pubDateObj = last.upload_date ? new Date(last.upload_date) : getTikTokDate(url);
                    let pubDateStr = pubDateObj ? pubDateObj.toLocaleDateString('fr-FR', {
                        day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
                    }) : "Inconnu";

                    // Calcul de la tendance
                    const trend = calculateTrend(history);

                    return {
                        account: last.account || "N/A",
                        title: last.title || 'Sans titre',
                        views: views,
                        trend: trend,
                        likes: likes,
                        ratio: ratio,
                        dateStr: timestamp,
                        pubDateStr: pubDateStr,
                        pubDateObj: pubDateObj || new Date(0),
                        url: url,
                        history: history // ON GARDE BIEN L'HISTORIQUE
                    };
                });

                renderTable();

            } catch(e) {
                console.error(e);
                document.getElementById('table_body').innerHTML = "<tr><td colspan='6' class='p-8 text-center text-slate-500 italic'>En attente de donnÃ©es...</td></tr>";
            }
        }

        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = (column === 'title' || column === 'account') ? 'asc' : 'desc';
            }
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('table_body');
            tbody.innerHTML = "";

            ['account', 'title', 'views', 'likes', 'ratio', 'pubDateObj'].forEach(col => {
                const span = document.getElementById('sort_' + col);
                if (span) {
                    if (col === currentSort.column) {
                        span.innerText = currentSort.direction === 'asc' ? 'â–²' : 'â–¼';
                        span.className = "text-blue-400 ml-1";
                    } else { span.innerText = ''; }
                }
            });

            globalData.sort((a, b) => {
                let valA = a[currentSort.column];
                let valB = b[currentSort.column];
                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            globalData.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-700/50 cursor-pointer transition border-b border-slate-700/50";
                
                // IMPORTANT: C'est ici qu'on gÃ¨re le clic sur la ligne
                tr.onclick = function() { showChart(item.title, item.history); };

                tr.innerHTML = `
                    <td class="p-4 text-xs font-bold text-blue-400 whitespace-nowrap">@${item.account}</td>
                    <td class="p-4 text-sm font-medium text-slate-200 truncate max-w-[180px]">
                        <a href="${item.url}" target="_blank" class="hover:text-blue-400 hover:underline transition z-20 relative" onclick="event.stopPropagation()">
                            ${item.title} ðŸ”—
                        </a>
                    </td>
                    <td class="p-4 text-center font-bold text-blue-400 text-sm">
                        ${item.views.toLocaleString()} 
                        <span class="${item.trend.color} ml-1 text-xs font-bold">${item.trend.icon}</span>
                    </td>
                    <td class="p-4 text-center font-bold text-red-400 text-sm">${item.likes.toLocaleString()}</td>
                    <td class="p-4 text-center font-bold text-yellow-400 text-sm">${item.ratio}%</td>
                    <td class="p-4 text-right text-[10px] text-slate-400 font-mono">${item.pubDateStr}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function showChart(title, history) {
            console.log("Ouverture du graphique pour:", title); // Debug

            document.getElementById('modalTitle').innerText = title;
            document.getElementById('chartModal').classList.add('active');

            if (myChart) { myChart.destroy(); }

            // Tri par date pour le graphique
            const sorted = history.sort((a, b) => {
                const da = new Date(a.last_updated || 0);
                const db = new Date(b.last_updated || 0);
                return da - db;
            });

            const ctx = document.getElementById('modalCanvas').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sorted.map(d => { 
                        // Gestion plus propre de l'heure
                        const ts = d.last_updated || 'N/A'; 
                        return ts.includes(' ') ? ts.split(' ')[1].substring(0, 5) : ts; 
                    }),
                    datasets: [
                        { label: 'Vues', data: sorted.map(d => d.views || 0), borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.3, pointRadius: 4, yAxisID: 'y' },
                        { label: 'Likes', data: sorted.map(d => d.likes || 0), borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.3, pointRadius: 4, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { type: 'linear', display: true, position: 'left', grid: { color: '#334155' }, ticks: { color: '#3b82f6' } },
                        y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#ef4444' } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    },
                    plugins: { legend: { labels: { color: '#cbd5e1' } } }
                }
            });
        }

        loadStats();
        setInterval(loadStats, 30000);
    </script>
</body>
</html>